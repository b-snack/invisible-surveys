class t{constructor(t={}){this.options={apiUrl:t.apiUrl||"http://localhost:5001/api",samplingInterval:t.samplingInterval||50,batchInterval:t.batchInterval||2e3,sessionId:t.sessionId||null,debug:t.debug||!1},this.sessionId=null,this.events=[],this.isInitialized=!1,this.lastMousePosition={x:0,y:0},this.lastScrollPosition=0,this.clickHistory=[],this.batchTimer=null,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleClick=this.handleClick.bind(this),this.handleScroll=this.handleScroll.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.handleBeforeUnload=this.handleBeforeUnload.bind(this),this.handleKeyPress=this.handleKeyPress.bind(this),this.log("PulseTracker initialized with options:",this.options)}log(...t){this.options.debug}async init(){if(this.isInitialized)this.log("Already initialized");else try{this.sessionId=await this.getOrCreateSessionId(),this.setupEventListeners(),this.startBatchTimer(),this.isInitialized=!0,this.log("Successfully initialized with session ID:",this.sessionId),this.trackNavigation(window.location.href)}catch(t){}}async getOrCreateSessionId(){let t=localStorage.getItem("pulse_session_id");if(t)this.log("Using existing session ID:",t);else try{const e=await fetch(`${this.options.apiUrl}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({page_url:window.location.href})}),i=await e.json();if(!i.success||!i.session_id)throw new Error("Failed to create session: "+(i.error||"Unknown error"));t=i.session_id,localStorage.setItem("pulse_session_id",t),this.log("Created new session:",t)}catch(e){t="local_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("pulse_session_id",t),this.log("Using local session ID:",t)}return t}setupEventListeners(){let t=null;document.addEventListener("mousemove",e=>{t||(t=setTimeout(()=>{this.handleMouseMove(e),t=null},this.options.samplingInterval))}),document.addEventListener("click",this.handleClick);let e=null;window.addEventListener("scroll",()=>{e||(e=setTimeout(()=>{this.handleScroll(),e=null},100))}),document.addEventListener("visibilitychange",this.handleVisibilityChange),window.addEventListener("beforeunload",this.handleBeforeUnload);let i=null;document.addEventListener("keydown",t=>{i||(i=setTimeout(()=>{this.handleKeyPress(t),i=null},100))});const s=history.pushState,n=history.replaceState;history.pushState=function(...t){s.apply(this,t),window.dispatchEvent(new Event("locationchange"))},history.replaceState=function(...t){n.apply(this,t),window.dispatchEvent(new Event("locationchange"))},window.addEventListener("popstate",()=>{window.dispatchEvent(new Event("locationchange"))}),window.addEventListener("locationchange",()=>{this.trackNavigation(window.location.href)}),this.log("Event listeners set up")}handleMouseMove(t){const e=t.clientX,i=t.clientY;Math.sqrt(Math.pow(e-this.lastMousePosition.x,2)+Math.pow(i-this.lastMousePosition.y,2))>1&&(this.lastMousePosition={x:e,y:i},this.addEvent("mouse_move",{x:e,y:i,viewport_width:window.innerWidth,viewport_height:window.innerHeight}))}handleClick(t){const e=t.clientX,i=t.clientY,s=Date.now(),n=this.getElementPath(t.target);this.clickHistory.push({x:e,y:i,timestamp:s}),this.clickHistory.length>10&&this.clickHistory.shift();const o=this.detectRageClick();this.addEvent(o?"rage_click":"click",{x:e,y:i,element:n,viewport_width:window.innerWidth,viewport_height:window.innerHeight,is_rage_click:o})}detectRageClick(){if(this.clickHistory.length<3)return!1;const t=this.clickHistory.slice(-3);if(t[2].timestamp-t[0].timestamp<=1e3){const e=t.map(t=>t.x),i=t.map(t=>t.y),s=e.reduce((t,e)=>t+e,0)/3,n=i.reduce((t,e)=>t+e,0)/3;return Math.max(...t.map((t,e)=>Math.sqrt(Math.pow(t.x-s,2)+Math.pow(t.y-n,2))))<=50}return!1}handleScroll(){const t=window.pageYOffset||document.documentElement.scrollTop,e=document.documentElement.scrollHeight-window.innerHeight,i=e>0?t/e*100:0;Math.abs(i-this.lastScrollPosition)>1&&(this.lastScrollPosition=i,this.addEvent("scroll",{percentage:Math.round(i),direction:t>this.lastScrollPosition?"down":"up",position:t}))}handleVisibilityChange(){this.addEvent("visibility",{state:document.visibilityState,hidden:document.hidden})}handleKeyPress(t){this.addEvent("keyboard",{key_code:t.keyCode,timestamp:Date.now(),is_modifier:t.ctrlKey||t.altKey||t.shiftKey||t.metaKey})}handleBeforeUnload(){this.sendBatch(!0)}trackNavigation(t){this.addEvent("navigation",{url:t,referrer:document.referrer,timestamp:Date.now()})}addEvent(t,e){const i={session_id:this.sessionId,type:t,timestamp:(new Date).toISOString(),data:e};this.events.push(i),this.log("Event added:",t,e),this.events.length>=100&&this.sendBatch()}startBatchTimer(){this.batchTimer=setInterval(()=>{this.sendBatch()},this.options.batchInterval)}async sendBatch(t=!1){if(0===this.events.length&&!t)return;const e=[...this.events];if(this.events=[],0!==e.length)try{const t=await fetch(`${this.options.apiUrl}/track`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:this.sessionId,events:e})}),i=await t.json();i.success?this.log(`Successfully sent ${i.count} events`):this.events=[...e,...this.events]}catch(t){this.events=[...e,...this.events]}}getElementPath(t){const e=[];let i=t;for(;i&&i!==document.body;){let t=i.tagName.toLowerCase();if(i.id)t+="#"+i.id;else if(i.className&&"string"==typeof i.className){const e=i.className.split(" ").filter(t=>t).join(".");e&&(t+="."+e)}if(e.unshift(t),i=i.parentElement,e.length>=5)break}return e.join(" > ")}destroy(){this.batchTimer&&(clearInterval(this.batchTimer),this.batchTimer=null),this.sendBatch(!0),this.isInitialized=!1,this.log("Destroyed")}}"undefined"!=typeof window&&(window.PulseTracker=t,document.addEventListener("DOMContentLoaded",()=>{const e=new t({debug:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname});e.init(),window.pulseTracker=e}));export default t;